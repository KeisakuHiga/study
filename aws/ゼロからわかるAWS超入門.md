# ゼロからわかる AWS 超入門

## 1. AWS を始める！！

### ルートユーザーアカウントは特別な時だけ使うようにしよ

ルートユーザーは AWS への全ての操作権限を保有することから万が一漏洩してしまったときはえらいことになる。。。

だから、普段使いのアカウントを作っておいて、特別な時だげルートユーザーを使った方がセキュリティ的にいい！

### AWS の操作をできるユーザーを IAM ユーザーという

AWS の各リソースに対する操作を「アクション」というけど、このアクションベースで IAM ユーザーの権限を設定していたら煩雑。。。だから「ポリシー」をベースに権限設定を行う。ポリシーっていうのは、アクションをグループ化したもの。

このポリシーは AWS 側から提供されているものがあって、各リソース毎に一般的な操作権限を簡単に設定することができる。

IAM ユーザーの他に、IAM グループと IAM ロールがある。

- IAM グループ：IAM ユーザーをグループ化して権限設定する概念。複数ユーザーに対して、同じ権限設定をしたい時に使う。
- IAM ロール：AWS のリソースに対するアカウント。例えば、EC2 から S3 にアクセス権限を付与する際に、IAM ロールだと楽に権限設定ができるようになる。

### 管理者ユーザーを作成してみよう

1. IAM ダッシュボードへ
1. 「ユーザー」メニューを選択
1. 「ユーザーを追加」を押下
   1. ユーザー名を入力
   1. アクセスの種類を選択
      1. プログラムによるアクセス
         1. API などから AWS を操作する際に必要な「アクセスキー」や「シークレットアクセスキー」を発行する時はチェック入れておく。
         1. 漏洩すると大変！不要ならチェック外して OK。後からでも作成できる。
      1. AWS マネジメントコンソールへのアクセス
         1. まずはこっちチェック入れる
         1. コンソールのパスワードは自動生成パスワードにチェック
      1. パスワードリセットが必要にもチェック
   1. 次のステップへ
1. ユーザーを追加
   1. ３つあるが、今回は「既存のポリシーを直接アタッチ」を選択
   1. ポリシーは一番上にある「AdministratorAccess」を選択
   1. 次のステップへ
1. タグの追加はしてもしなくても OK
1. 内容を確認して、「ユーザーの作成」押下

作成できたら、仮パスワードが自動生成されているから、それを手元に控えておくか、CSV をダンロードしておく。AWS アカウント ID とユーザー名と仮パスワードを入力して初回ログイン、パスワード初期設定できたら完了！AWS アカウント ID がわからない場合は[ここ参照する](https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/console_account-alias.html)。

### セキュリティステータス

実運用を開始する場合、IAM ダッシュボードでは、セキュリティ上、以下の５つのことを設定する必要があるらしい。実験的な場合は１と３が最低限の設定。

1. ルートアクセスキーの削除
1. ルートアカウントの MFA を有効化
1. 個々の IAM ユーザーの作成
1. グループを使用してアクセス許可を割り当て
1. IAM パスワードポリシーの適用

### とてつもない金額を請求されないようにしておくことは？

AWS は使った分だけ課金されるシステムだから、EC2 などの AWS リソースを沢山使用すると、もしかするととてつも無い金額を請求される可能性もある。

それを回避するために常時`Billing`に張り付いているのは非効率的。そこで一定期間の予算を事前に設定しておいて、その予算限度に近づいてきた時に自動で通知（メール）が来るように設定できる。

#### AWS Budget を設定する

1. `Billing`から`Budgets`メニューを選択
1. 「予算を作成」押下
1. 予算名と予算期間と予算額を決める（フィルタリング予算はまずはデフォルトで OK）
1. どのタイミングで通知するか、どのメールアドレス宛に通知するかを設定
1. 「予算の確認」をして、確認画面で「作成」押下

## 2. 静的ウェブサイトを公開する！S3

### ウェブサイトを公開する方法は２パターン

1.  EC2 を使う方法（un-managed）  
    EC2 に Apach や nginx などのソフトウェアをインストールしたりする。プログラムを実行したりする必要があるならばこの方法で。詳しくは３章参照。

1.  S3 を使う方法（managed）  
    あらかじめアップロードしたコンテンツのみを見せるだけの場合はこの方法で OK。

    1. 「静的ウェブサイトホスティングを編集」という機能を有効にする
    1. 匿名アクセスを有効にする

### S3 の注意点

1. S3 のバケット名は後から変更ができないため、名前を変更したくなったら、新しいバケットを作成して、AWS CLI からの操作で、[旧バケットから新バケットにコピーする必要がある。](https://r17n.page/2020/01/11/aws-copy-s3/)
1. S3 バケットの Web 機能は暗号化（HTTPS）に対応していない。もし対応させたいならば、「CloudFront（コンテンツのキャッシュ機能を提供する）」サービスを S3 バケットの前に設置しないといけない。詳細は６章で。

### S3 バケットの命名規則

1. AWS 上の他の S3 バケットと被らないように唯一の名前を命名する必要がある
1. 独自のドメイン名を使用すると他 AWS ユーザーと被ることがなくなるから推奨されている。

### S3 の使用料

[公式 Doc](https://aws.amazon.com/jp/s3/pricing/):

> 実際に使用した分だけお支払いいただきます。最低料金設定はありません。データプロファイルに最適な S3 ストレージクラスを決定する際に検討すべきコスト要素は 4 つあります。ストレージ料金、リクエストとデータ取り出しの料金、データ転送と転送高速化の料金、データ管理機能の料金です。

[見積もりツール](https://calculator.aws/#/)もあるから便利！

### S3 のストレージクラス

[S ３の品質を示す６つのクラスがある。](https://aws.amazon.com/jp/s3/storage-classes/?nc=sn&loc=3)

1. 標準（デフォルト）  
   複数のアベイラビリティゾーンで運用（＝冗長性 ◯）
1. Intelligent-Tiering
1. 標準 - 低頻度アクセス  
   可用性や信頼性を少し犠牲にして低コストを実現
1. 1 ゾーン - 低頻度アクセス  
   可用性や信頼性を少し犠牲にして低コストを実現
1. [Glacier](https://ejje.weblio.jp/content/glacier)  
   保存したらほとんど参照しない用途 - バックアップデータ・ログデータの保存に使われやすい。参照には時間と費用がかかるけど、低コストでデータ保存できる。
1. [Glacier](https://ejje.weblio.jp/content/glacier) Deep Archive  
   保存したらほとんど参照しない用途 - バックアップデータ・ログデータの保存に使われやすい。参照にはめっちゃ時間かかるけど、めっちゃ低コストでデータ保存できる。

### 静的 Web サイトを S3 で構築する

1. S3 バケット作る
   1. ドメイン名でアクセスする場合は、そのバケット名を指定すること。それ以外なら他の S3 バケットと被らない名前をつける。
   1. リージョンの指定。今回「東京」に設定する。
   1. 「バケット作成」押下、で完了！
1. [静的ウェブサイトホスティング](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/WebsiteHosting.html)を有効化

   1. 作成したバケットのプロパティ画面へ
   1. 「静的ウェブサイトホスティングを編集」を選択
   1. 静的ウェブサイトホスティングを「有効にする」
   1. インデックスドキュメントに「index.html」を指定
   1. エラードキュメントに「error.html」を指定
   1. リダイレクトルールは空欄で OK。これは、コンテンツの一部が別のサーバーにある時に使う設定。
   1. 「変更の保存」
   1. バケットウェブサイトエンドポイントを確認しておこう！http://www.keisakubookexample.com.s3-website-ap-northeast-1.amazonaws.com

1. パブリックバケットポリシーの管理ができるようにする

   1. 「アクセス許可」タブ押下
   1. 「ブロックパブリックアクセス (バケット設定)」の「編集」押下
   1. 以下のチェックを外して、「変更の保存」→「確認」入力 →「確認」
      1. _新しいパブリックバケットポリシーまたはアクセスポイントポリシーを介して付与されたバケットとオブジェクトへのパブリックアクセスをブロックする_
      1. _任意のパブリックバケットポリシーまたはアクセスポイントポリシーを介したバケットとオブジェクトへのパブリックアクセスとクロスアカウントアクセスをブロックする_

1. 匿名アクセスを有効化・バケットポリシーの設定  
   何も設定をしていない為、バケットウェブサイトエンドポイントにアクセスしようとしても 403 Forbidden ページへ。全ユーザーに読み取り権限を与えるポリシーデータを用意しよう。[公式 Doc - S3 アクセス管理の概要](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/access-control-overview.html)。

   1. 以下の JSON 形式データを設定すると匿名アクセスを有効化させることができる

      ```json
      {
      	"Version": "2012-10-17",
      	"Statement": [
      		{
      			"Sid": "GrantAnonymousReadPermissions",
      			"Effect": "Allow",
      			"Principal": "*",
      			"Action": ["s3:GetObject"],
      			"Resource": [
      				"arn:aws:s3:<リージョン>:<アカウント>:<バケット名>/<パス名>"
      			]
      		}
      	]
      }
      ```

   1. Resource（バケット名）を変更する。リージョン、アカウント名を指定しない場合は「（空文字）」でも OK。パス名は「\*」に設定する。
      ```json
      {
      	"Version": "2012-10-17",
      	"Statement": [
      		{
      			"Sid": "GrantAnonymousReadPermissions",
      			"Effect": "Allow",
      			"Principal": "*",
      			"Action": ["s3:GetObject"],
      			"Resource": ["arn:aws:s3:::www.keisakubookexample.com/*"]
      		}
      	]
      }
      ```
   1. バケットポリシーを「編集する」
   1. 上記 ii の`json`データを設定して「変更の保存」

1. 公開したいファイルをアップロード  
   まだ公開ようのファイルをアップロードしていないから 404 NotFound 画面に遷移するはず。

   1. `index.html`を適当に作成する
      ```html
      <!DOCTYPE html>
      <html lang="en">
      	<head>
      		<meta charset="UTF-8" />
      		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
      		<meta
      			name="viewport"
      			content="width=device-width, initial-scale=1.0"
      		/>
      		<title>ゼロからわかるAWS超入門</title>
      	</head>
      	<body>
      		<h1>Welcome S3 Bucket!!!</h1>
      	</body>
      </html>
      ```
   1. アップロード画面から`index.html`をアップロードする
   1. アップロードが完了したら、もう一度ブラウザから確認してみる
   1. `index.html`を編集して、`index.html`と`a.jpg`をアップロードしよう
      ```html
      <!DOCTYPE html>
      <html lang="en">
      	<head>
      		<meta charset="UTF-8" />
      		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
      		<meta
      			name="viewport"
      			content="width=device-width, initial-scale=1.0"
      		/>
      		<title>ゼロからわかるAWS超入門</title>
      	</head>
      	<body>
      		<h1>Welcome S3 Bucket!!!</h1>
      		<img src="a.jpg" />
      	</body>
      </html>
      ```
   1. アップロードが完了したら、もう一度ブラウザから確認してみる
   1. やったね！

### S3 の管理操作できるポリシー

「S3FullAccess」というポリシーが付与された IAM ユーザーじゃないと S3 の操作ができないよ！

### ユーザーポリシーとバケットポリシー

S3 バケットにアクセス圏を設定するには２通りある。「アクセスする側（ユーザー側）」と「アクセスされる側（S3 バケット側）」のどっちに設定するかという違い。

#### ユーザーポリシーのイメージ

| ユーザー名 | ポリシー（アクセスできるバケットはどれ？） |
| ---------- | ------------------------------------------ |
| 太郎       | なし                                       |
| 花子       | A                                          |
| 神         | 全てのバケット                             |

#### バケットポリシーのイメージ

| バケット名 | ポリシー（誰に対してオープン？） |
| ---------- | -------------------------------- |
| A          | なし（完全クローズ）             |
| B          | 犬と猫                           |
| C          | 全てのユーザー                   |

### ツールを使ってアップロードすることもできる

ドラッグ＆ドロップ操作で S3 を扱えるツールに以下のものがあるらしい。使い方は割愛するが、認証のために「アクセスキー ID」と「シークレットアクセスキー」を S3 で発行して、それらを以下ツールの初期設定で使用するっぽい。

- Windows: [S3 Browser](https://s3browser.com/)
- Mac: [CyberDuck](https://cyberduck.io/)

## 3. LAMP サーバーで WordPress を動かす！EC2

『[AWS 基礎からのネットワーク&サーバー構築](aws/AWS基礎からのネットワーク&サーバー構築.md)』でやったこと以外のことをここではメモしていく。

### EC2 のインスタンスタイプ

色々あるらしい。大きく分けると以下の分類みたい。インスタンスタイプは変更がきくため、一般的には、低スペックのインスタンスタイプでスタートさせて、必要に応じてアップグレードさせる方がいい。詳細は[公式](https://aws.amazon.com/jp/ec2/instance-types/)を参照する。

1. **汎用**: バランスの取れたコンピューティング、メモリ、ネットワークのリソースを提供し、多様なワークロードに使用。
   1. 開発用や実験用のサーバーとして[T2](https://aws.amazon.com/jp/ec2/instance-types/t2/)タイプがよく使われるらしい。AWS 無料枠で提供されているもの。負荷が高い時にその分だけ性能をあげる「バースト機能」がある。
   1. 本番運用の際には[M5](https://aws.amazon.com/jp/ec2/instance-types/m5/)タイプがよく使われるらしい。
1. **コンピューティング最適化**: 高パフォーマンスプロセッサの恩恵を受けるコンピューティングバウンドなアプリケーションに最適
1. **メモリ最適化**: メモリ内の大きいデータセットを処理するワークロードに対して高速なパフォーマンスを実現
1. **高速コンピューティング**: ハードウェアアクセラレーター (コプロセッサ) を使用して、浮動小数点計算、グラフィックス処理、データパターン照合などの機能を、CPU で実行中のソフトウェアよりも効率的に実行
1. **ストレージ最適化**：ローカルストレージの大規模データセットに対する高いシーケンシャル読み取りおよび書き込みアクセスを必要とするワークロード用

### ブロックストレージ？

[ここ](https://pfs.nifcloud.com/navi/words/block_storage.htm#:~:text=%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8%E3%81%AF%E3%80%81%E8%A8%98%E9%8C%B2%E9%A0%98%E5%9F%9F,%E3%81%A6%E7%AE%A1%E7%90%86%E3%81%99%E3%82%8B%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8%E3%81%A7%E3%81%99%E3%80%82)を参考にした。

> コンピューター上のデータを長期保存するために使われる、ハードディスクのような補助記憶装置を総じて「ストレージ」と呼びます。ストレージにはさまざまな種類がありますが、ボリュームとブロックという論理的な単位で管理するストレージを「ブロックストレージ」と呼びます。

EBS の公式 Doc は[ここ ](https://aws.amazon.com/jp/ebs/?ebs-whats-new.sort-by=item.additionalFields.postDateTime&ebs-whats-new.sort-order=desc)。

> Amazon Elastic Block Store (EBS) は、Amazon Elastic Compute Cloud (EC2) と共に使用するために設計された、スループットとトランザクションの両方が集中するどんな規模のワークロードにも対応できる、使いやすい高性能なブロックストレージサービス

## 4. データベースを活用する！RDS

### データベースを EC2 じゃなくて RDS で構成する

『[AWS 基礎からのネットワーク&サーバー構築](aws/AWS基礎からのネットワーク&サーバー構築.md)』では、EC2 をデータベースサーバーとして構成したけれど、ここでは[**RDS(Relational Database Service)**](https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/UserGuide/Welcome.html)を使う。

- メンテナンスを AWS に任せられるマネージドサービス＝出来合いの DB を借りる
- 冗長化とかバックアップなどデータを安全に運用するのに必要なこともあんまり考えなくても良さげ

### この章でやること

- RDS でデータベースインスタンスを作る
- MariaDB からの以降
- データベースのバックアップ

### RDS を使うメリット・デメリット

メリット

- マネージドサービスだから
  - データベースソフトウェアのアップデートなどの保守管理が楽
  - マネージドサービスだからデータベースのバックアップ・冗長化などを AWS に任せることができる
  - 安定したデータベース運用が実現できる

デメリット

- EC2 で運用するよりも少しコストがかかる
- データベース構成の自由度が低い
  - 標準的な構成のデータベースのため高度なカスタムチューニングができない

基本的には安全なデータベース運用が優先されるケースが多いようで、データベースは EC2 で管理せず RDS を活用することが一般的。ただ、**RDS 完全無停止はありえず**、データベースソフトウェアアップデートなどを行う際、AWS 側から事前連絡があった上で、数分程度ストップせざるを得ないことがあることは頭においておくこと。

### RDS を停止させる通知が来た時の３つの選択肢

1. AWS マネジメントコンソールから即アップデートする
1. 時間帯を設定して、その時間帯で更新する
1. アップデートしない（＝問題を先送りにする）

完全無停止を実現しようとするならば、複数のデータベースインスタンスで構成し、１つずつメンテ期間をずらして順番にアップデートさせるなど工夫が必要になる。

### EC2 から移行する時に気にするポイント

- 管理者のユーザー名とパスワード：これを使ってアプリからアクセスする
- DB インスタンスの配置先：アプリと同じサブネット内に配置する
- パブリック IP アドレス：割り当てない。外部からアクセス出来るリスクは無くすように。
- エンドポイント：アプリから接続する時に必要になるからメモっとく。
- セキュリティグループ：アプリから接続出来るように設定しておく。

### アプリの EC2 インスタンスから MariaDB を移行する手順イメージ

1. 現在のデータを DB インスタンスにコピー
   - `mysqldump`コマンドでバックアップ（ダンプファイル）を作成する
   - リストアする
1. WordPress のデータベース設定を変更して、アプリからデータベースインスタンスに接続できるようにする
1. 旧 MariaDB を停止させる。（※アンインストールする場合でも、データベース本体のみ！必要なライブラリは消すな！）

### RDS インスタンスを作成する

1. DB設計（登録項目） - 先に考えておかないといけなこともあるよ

   | 項目                         | 設定値                                    |
   | ---------------------------- | ----------------------------------------- |
   | データベース作成方法         | 標準作成                                  |
   | エンジンのタイプ             | MariaDB                                   |
   | バージョン                   | MariaDB 10.4.13                           |
   | テンプレート                 | 無料利用枠                                |
   | DB インスタンスの識別子      | wordpressdb                               |
   | マスターユーザー名           | root                                      |
   | マスターパスワード           | myrdspassword                             |
   | DB インスタンスクラス        | db.t2.micro                               |
   | マルチ AZ 配置               | しない                                    |
   | ストレージタイプと割り当て   | 汎用（SSD）/20GiB                         |
   | VPC                          | アプリの EC2 インスタンスがある VPC       |
   | 既存の VPC セキュリティグループ  | DB のSGを選択       |
   | サブネット                   | アプリの EC2 インスタンスがあるサブネット |
   | パブリックアクセスシビリティ | いいえ                                    |
   | アベイラビティゾーン         | アプリの EC2 インスタンスがある AZ        |
   | データベースポート番号        | 3306        |
   | ログのエクスポート            | 全てにチェック入れる                        |
   | その他項目                   | デフォルトの値                            |

1. RDS DB インスタンスを作成開始

   1. EC2（アプリ）インスタンスの AZ を調べる
   1. RDS ダッシュボードでリージョンが「東京」であることを確認
   1. 「データベースの作成」押下、登録項目は上記「DB設計」の通り設定
   1. 「データベースの作成」押下

### データベースのバックアップ

## 5. ドメインを取得する！Route53

## 6. 安全な通信を！Certificate Management
