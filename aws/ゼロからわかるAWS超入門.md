# ゼロからわかる AWS 超入門

## 1. AWS を始める！！

### ルートユーザーアカウントは特別な時だけ使うようにしよ

ルートユーザーは AWS への全ての操作権限を保有することから万が一漏洩してしまったときはえらいことになる。。。

だから、普段使いのアカウントを作っておいて、特別な時だげルートユーザーを使った方がセキュリティ的にいい！

### AWS の操作をできるユーザーを IAM ユーザーという

AWS の各リソースに対する操作を「アクション」というけど、このアクションベースで IAM ユーザーの権限を設定していたら煩雑。。。だから「ポリシー」をベースに権限設定を行う。ポリシーっていうのは、アクションをグループ化したもの。

このポリシーは AWS 側から提供されているものがあって、各リソース毎に一般的な操作権限を簡単に設定することができる。

IAM ユーザーの他に、IAM グループと IAM ロールがある。

- IAM グループ：IAM ユーザーをグループ化して権限設定する概念。複数ユーザーに対して、同じ権限設定をしたい時に使う。
- IAM ロール：AWS のリソースに対するアカウント。例えば、EC2 から S3 にアクセス権限を付与する際に、IAM ロールだと楽に権限設定ができるようになる。

### 管理者ユーザーを作成してみよう

1. IAM ダッシュボードへ
1. 「ユーザー」メニューを選択
1. 「ユーザーを追加」を押下
   1. ユーザー名を入力
   1. アクセスの種類を選択
      1. プログラムによるアクセス
         1. API などから AWS を操作する際に必要な「アクセスキー」や「シークレットアクセスキー」を発行する時はチェック入れておく。
         1. 漏洩すると大変！不要ならチェック外して OK。後からでも作成できる。
      1. AWS マネジメントコンソールへのアクセス
         1. まずはこっちチェック入れる
         1. コンソールのパスワードは自動生成パスワードにチェック
      1. パスワードリセットが必要にもチェック
   1. 次のステップへ
1. ユーザーを追加
   1. ３つあるが、今回は「既存のポリシーを直接アタッチ」を選択
   1. ポリシーは一番上にある「AdministratorAccess」を選択
   1. 次のステップへ
1. タグの追加はしてもしなくても OK
1. 内容を確認して、「ユーザーの作成」押下

作成できたら、仮パスワードが自動生成されているから、それを手元に控えておくか、CSV をダンロードしておく。AWS アカウント ID とユーザー名と仮パスワードを入力して初回ログイン、パスワード初期設定できたら完了！AWS アカウント ID がわからない場合は[ここ参照する](https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/console_account-alias.html)。

### セキュリティステータス

実運用を開始する場合、IAM ダッシュボードでは、セキュリティ上、以下の５つのことを設定する必要があるらしい。実験的な場合は１と３が最低限の設定。

1. ルートアクセスキーの削除
1. ルートアカウントの MFA を有効化
1. 個々の IAM ユーザーの作成
1. グループを使用してアクセス許可を割り当て
1. IAM パスワードポリシーの適用

### とてつもない金額を請求されないようにしておくことは？

AWS は使った分だけ課金されるシステムだから、EC2 などの AWS リソースを沢山使用すると、もしかするととてつも無い金額を請求される可能性もある。

それを回避するために常時`Billing`に張り付いているのは非効率的。そこで一定期間の予算を事前に設定しておいて、その予算限度に近づいてきた時に自動で通知（メール）が来るように設定できる。

#### AWS Budget を設定する

1. `Billing`から`Budgets`メニューを選択
1. 「予算を作成」押下
1. 予算名と予算期間と予算額を決める（フィルタリング予算はまずはデフォルトで OK）
1. どのタイミングで通知するか、どのメールアドレス宛に通知するかを設定
1. 「予算の確認」をして、確認画面で「作成」押下

## 2. 静的ウェブサイトを公開する！S3

### ウェブサイトを公開する方法は２パターン

1.  EC2 を使う方法（un-managed）  
    EC2 に Apach や nginx などのソフトウェアをインストールしたりする。プログラムを実行したりする必要があるならばこの方法で。詳しくは３章参照。

1.  S3 を使う方法（managed）  
    あらかじめアップロードしたコンテンツのみを見せるだけの場合はこの方法で OK。

    1. 「静的ウェブサイトホスティングを編集」という機能を有効にする
    1. 匿名アクセスを有効にする

### S3 の注意点

1. S3 のバケット名は後から変更ができないため、名前を変更したくなったら、新しいバケットを作成して、AWS CLI からの操作で、[旧バケットから新バケットにコピーする必要がある。](https://r17n.page/2020/01/11/aws-copy-s3/)
1. S3 バケットの Web 機能は暗号化（HTTPS）に対応していない。もし対応させたいならば、「CloudFront（コンテンツのキャッシュ機能を提供する）」サービスを S3 バケットの前に設置しないといけない。詳細は６章で。

### S3 バケットの命名規則

1. AWS 上の他の S3 バケットと被らないように唯一の名前を命名する必要がある
1. 独自のドメイン名を使用すると他 AWS ユーザーと被ることがなくなるから推奨されている。

### S3 の使用料

[公式 Doc](https://aws.amazon.com/jp/s3/pricing/):

> 実際に使用した分だけお支払いいただきます。最低料金設定はありません。データプロファイルに最適な S3 ストレージクラスを決定する際に検討すべきコスト要素は 4 つあります。ストレージ料金、リクエストとデータ取り出しの料金、データ転送と転送高速化の料金、データ管理機能の料金です。

[見積もりツール](https://calculator.aws/#/)もあるから便利！

### S3 のストレージクラス

[S ３の品質を示す６つのクラスがある。](https://aws.amazon.com/jp/s3/storage-classes/?nc=sn&loc=3)

1. 標準（デフォルト）  
   複数のアベイラビリティゾーンで運用（＝冗長性 ◯）
1. Intelligent-Tiering
1. 標準 - 低頻度アクセス  
   可用性や信頼性を少し犠牲にして低コストを実現
1. 1 ゾーン - 低頻度アクセス  
   可用性や信頼性を少し犠牲にして低コストを実現
1. [Glacier](https://ejje.weblio.jp/content/glacier)  
   保存したらほとんど参照しない用途 - バックアップデータ・ログデータの保存に使われやすい。参照には時間と費用がかかるけど、低コストでデータ保存できる。
1. [Glacier](https://ejje.weblio.jp/content/glacier) Deep Archive  
   保存したらほとんど参照しない用途 - バックアップデータ・ログデータの保存に使われやすい。参照にはめっちゃ時間かかるけど、めっちゃ低コストでデータ保存できる。

### 静的 Web サイトを S3 で構築する

1. S3 バケット作る
   1. ドメイン名でアクセスする場合は、そのバケット名を指定すること。それ以外なら他の S3 バケットと被らない名前をつける。
   1. リージョンの指定。今回「東京」に設定する。
   1. 「バケット作成」押下、で完了！
1. [静的ウェブサイトホスティング](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/WebsiteHosting.html)を有効化

   1. 作成したバケットのプロパティ画面へ
   1. 「静的ウェブサイトホスティングを編集」を選択
   1. 静的ウェブサイトホスティングを「有効にする」
   1. インデックスドキュメントに「index.html」を指定
   1. エラードキュメントに「error.html」を指定
   1. リダイレクトルールは空欄で OK。これは、コンテンツの一部が別のサーバーにある時に使う設定。
   1. 「変更の保存」
   1. バケットウェブサイトエンドポイントを確認しておこう！http://www.keisakubookexample.com.s3-website-ap-northeast-1.amazonaws.com

1. パブリックバケットポリシーの管理ができるようにする

   1. 「アクセス許可」タブ押下
   1. 「ブロックパブリックアクセス (バケット設定)」の「編集」押下
   1. 以下のチェックを外して、「変更の保存」→「確認」入力 →「確認」
      1. _新しいパブリックバケットポリシーまたはアクセスポイントポリシーを介して付与されたバケットとオブジェクトへのパブリックアクセスをブロックする_
      1. _任意のパブリックバケットポリシーまたはアクセスポイントポリシーを介したバケットとオブジェクトへのパブリックアクセスとクロスアカウントアクセスをブロックする_

1. 匿名アクセスを有効化・バケットポリシーの設定  
   何も設定をしていない為、バケットウェブサイトエンドポイントにアクセスしようとしても 403 Forbidden ページへ。全ユーザーに読み取り権限を与えるポリシーデータを用意しよう。[公式 Doc - S3 アクセス管理の概要](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/access-control-overview.html)。

   1. 以下の JSON 形式データを設定すると匿名アクセスを有効化させることができる

      ```json
      {
      	"Version": "2012-10-17",
      	"Statement": [
      		{
      			"Sid": "GrantAnonymousReadPermissions",
      			"Effect": "Allow",
      			"Principal": "*",
      			"Action": ["s3:GetObject"],
      			"Resource": [
      				"arn:aws:s3:<リージョン>:<アカウント>:<バケット名>/<パス名>"
      			]
      		}
      	]
      }
      ```

   1. Resource（バケット名）を変更する。リージョン、アカウント名を指定しない場合は「（空文字）」でも OK。パス名は「\*」に設定する。
      ```json
      {
      	"Version": "2012-10-17",
      	"Statement": [
      		{
      			"Sid": "GrantAnonymousReadPermissions",
      			"Effect": "Allow",
      			"Principal": "*",
      			"Action": ["s3:GetObject"],
      			"Resource": ["arn:aws:s3:::www.keisakubookexample.com/*"]
      		}
      	]
      }
      ```
   1. バケットポリシーを「編集する」
   1. 上記 ii の`json`データを設定して「変更の保存」

1. 公開したいファイルをアップロード  
まだ公開ようのファイルをアップロードしていないから404 NotFound画面に遷移するはず。

   1. `index.html`を適当に作成する
        ```html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ゼロからわかるAWS超入門</title>
        </head>
        <body>
            <h1>Welcome S3 Bucket!!!</h1>
        </body>
        </html>
        ```
   1. アップロード画面から`index.html`をアップロードする
   1. アップロードが完了したら、もう一度ブラウザから確認してみる
   1. `index.html`を編集して、`index.html`と`a.jpg`をアップロードしよう
        ```html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ゼロからわかるAWS超入門</title>
        </head>
        <body>
            <h1>Welcome S3 Bucket!!!</h1>
            <img src="a.jpg">
        </body>
        </html>
        ```
   1. アップロードが完了したら、もう一度ブラウザから確認してみる


### S3 の管理操作できるポリシー

「S3FullAccess」というポリシーが付与された IAM ユーザーじゃないと S3 の操作ができないよ！

### ユーザーポリシーとバケットポリシー
S3バケットにアクセス圏を設定するには２通りある。「アクセスする側（ユーザー側）」と「アクセスされる側（S3バケット側）」のどっちに設定するかという違い。
#### ユーザーポリシーのイメージ
|ユーザー名|ポリシー（アクセスできるバケットはどれ？）|
|---|---|
|太郎|なし|
|花子|A|
|神|全てのバケット|
#### バケットポリシーのイメージ
|バケット名|ポリシー（誰に対してオープン？）|
|---|---|
|A|なし（完全クローズ）|
|B|犬と猫|
|C|全てのユーザー|

## 3. LAMP サーバーで WordPress を動かす！EC2

## 4. データベースを活用する！RDS

## 5. ドメインを取得する！Route53

## 6. 安全な通信を！Certificate Management
